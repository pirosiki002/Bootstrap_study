<script>
  //スプレッドシートの最大行と列を設定
  const MAX_ROW = 6;  //spreadsheet_data.lengthと合わせないといけない
  const MAX_COL = 2;
  //英語と日本語の設定
  const ENG_WORD_COL = 0;
  const JPN_WORD_COL = 1;
  //時間制限設定
  const LIMIT_TIME_VALID   = 1;                 //時間制限有効
  const LIMIT_TIME_INVALID = 0;                 //時間制限無効
  const HINT_VALID   = 'あり';                   //ヒント有効
  const HINT_INVALID = 'なし';                   //ヒント無効
  const TIME_REMAIN_COLLECT = 2000;             //正解時に次の問題に移行する時間(msec)
  const TIME_REMAIN        = 4000;              //次の問題に移行する時間(msec)
  let g_LTime_valid        = LIMIT_TIME_VALID;  //初期設定は時間制限有効
  let g_LTime              = 0;                 //１問ごとの制限時間
  let g_hint_valid         = 0;                 //ヒント機能あり／なし

  //問題のタイプ
  const Q_TYPE_ENG = "英単語⇨日本語";
  const Q_TYPE_JPN = "日本語⇨英単語";
  let g_Q_type = Q_TYPE_ENG;  //初期設定は英語
  let g_gas_data_arr; //単語一覧格納用のグローバル変数

  //*********************************
  //ファイルロード時の処理
  //*********************************
  function loadingProcess(){
    console.log("js loadingProcess() called");
    //サーバーからスプレッドシートのデータを取得する
    google.script.run.withSuccessHandler(getGASdata).GetSpreadsheet();
  }

  window.addEventListener('load', loadingProcess);

  //*********************************
  //GASのデータを取得
  //*********************************
  function getGASdata(spreadsheet_data){
    console.log("js getGASdata() called");
    console.log("spreadsheet_data.length = ", spreadsheet_data.length);

    //代入用の配列をNew
    g_gas_data_arr = new Array(spreadsheet_data.length);
    for (let i = 0; i < g_gas_data_arr.length; i++){
      g_gas_data_arr[i] = new Array(MAX_COL);
    }

    for(let row = 0; row < spreadsheet_data.length; row++){
      //最初のタイトル行を削除する分、サイズを1行分-1しておく
      for(let col = 0; col < spreadsheet_data[row].length; col++){
        //グローバル配列に設定
        g_gas_data_arr[row][col] = spreadsheet_data[row][col];    //1行目（row=0)はタイトル文字が入っている。2行目（row=1)から設定する
        console.log("g_gas_data_arr" + "[" + row + "]" + "[" + col + "]=" + g_gas_data_arr[row][col]);
      }
    }

    //各種設定を読み込む
    //問題の種類が英語か日本語か
    g_Q_type = spreadsheet_data[1][4];
    //時間制限が有効か無効か？
    g_LTime_valid = spreadsheet_data[2][4];
    //１問ごとの設定時間
    g_LTime       = spreadsheet_data[3][4];
    //ヒント機能あり／なし
    g_hint_valid  = spreadsheet_data[4][4]; 
  }

  //まずHtmlの要素を格納
  const subject = document.getElementById('subject');
  const hint    = document.getElementById('hint');
  const blind_hint = document.getElementById('blind_hint');
  const timer   = document.getElementById('timer');  //カウントダウン用
  const form    = document.forms.typing;

  //グローバル変数定義
  let g_time = g_LTime;     //カウントダウン用
  let g_q_cnt = 0;          //問題数カウント用
  let g_correct_cnt = 0;    //正解数カウント用
  let g_answer = 0;         //回答のグローバル変数（あとで消す予定）
  let g_hint_opacity = 0;   //ヒントの透明度
  let state = true;         //問題を解いている最中かを状態管理（名前変えた方がよいかも）

  //*********************************
  //カウントダウン
  //*********************************
  const countdown = setInterval(function() {

    if(g_LTime_valid === '時間制限なし'){
      //制限時間なしなら処理しない（暫定対応）
      timer.textContent = '制限時間なし';
      return;
    }

    //すでに0秒以下なら処理なし
    if(g_time <= 0){
      return;
    }

    //残り10秒以下ならヒントを表示
    if(g_time < 6){
      if(g_hint_opacity < 1){
        g_hint_opacity += 0.1;
        console.log('g_hint_opacity =', g_hint_opacity);
        blind_hint.style.opacity = g_hint_opacity;
      }
    }

    timer.textContent = '制限時間：' + --g_time + '秒';
    if(g_time <= 0) {

      // 正解を表示して次の問題へ！
      subject.textContent = '時間切れです！正解は' + g_answer;
      setTimeout(function(){ init() },TIME_REMAIN) //TIME_REMAINに設定した時間でタイムアウト
      //ヒント透明度の初期化
      g_hint_opacity = 0;
      blind_hint.style.opacity = 0;

    }
  }, 1000);

  //*********************************
  //判定処理
  //*********************************
  function judge() {
    if(!state) return;  //すでに終了していたら操作させない

    // 正誤を判定
    if(form.input.value === g_answer) {
      subject.textContent = '正解！';
      hint.textContent = '';  //ヒントを初期化
      hint.textContent = g_answer;
      //ヒントの透過度も初期化
      g_hint_opacity = 0;
      blind_hint.style.opacity = 0;

      g_correct_cnt++;  //正解数をインクリメント
      setTimeout(function(){ init() },TIME_REMAIN_COLLECT) //TIME_REMAIN_COLLECTに設定した時間でタイムアウト

    } else {
      subject.textContent = '間違いです！';
      hint.textContent = '';  //ヒントを初期化
      hint.textContent = g_answer;
      //ヒントの透過度も初期化
      g_hint_opacity = 0;
      blind_hint.style.opacity = 0;

      setTimeout(function(){ init() },TIME_REMAIN) //TIME_REMAINに設定した時間でタイムアウト
    }
  }

  //*********************************
  //Enterイベント処理
  //*********************************
  // Enterキー押下時、送信処理が実行する
  window.document.onkeydown = function(event){
      if (event.key === 'Enter') {
        judge();
      }
  }

  //*********************************
  //初期化処理
  //*********************************
  function init() {
    // タイマーリセット
    g_time = g_LTime;

    //ランダムで問題をひとつ生成
    const rnd = Math.floor(Math.random() * g_gas_data_arr.length);
    console.log("init() rnd=", rnd);

    //暫定対応！！もし0ならやり直し
    if(0 === rnd){
      init();
      return;
    }

    if(Q_TYPE_ENG === g_Q_type){
      //英語モード
      //問題となる英単語をセット
      subject.textContent = g_gas_data_arr[rnd][0];
      //答えもセットしておく
      g_answer = g_gas_data_arr[rnd][1];
    }
    else if(Q_TYPE_JPN === g_Q_type){
      //日本語モード。英語モードとは設定が逆になる
      subject.textContent = g_gas_data_arr[rnd][1];
      g_answer = g_gas_data_arr[rnd][0];
    }

    //ヒントを表示する
    if(HINT_VALID === g_hint_valid){
      console.log('ヒント機能が有効です g_answer=', g_answer.length);
      hint.textContent = '';  //ヒントの初期化
      //文字数の分だけ■をつける
      for(let i = 0; i < g_answer.length; i++){
        hint.textContent += '■';
        //空白の時はスペースをあける？？
      }

      //ヒントを透明化して設定しておく
      blind_hint.style.opacity = 0;
      blind_hint.textContent = g_answer;

    }

    form.input.value = '';  //入力欄を空白で初期化
    form.input.focus();     //フォーカスをあてる
  }


  //*********************************
  //開始時の処理
  //*********************************
  function start() {

    state = true;     //操作ロック解除
    init();           //init()関数を呼ぶことでゲーム開始！

  }

  //*********************************
  //終了時の処理
  //*********************************
  function finish() {
    // clearInterval(countdown); //タイマーストップ
    g_time = 0; //タイマーストップの代わりに残り時間を0に設定
    subject.textContent = '終了！正解数は' + g_correct_cnt + '問でした！';

    g_correct_cnt = 0;  //正解数を初期化

    //終了後に操作できないようにする
    state = false;
  }

  </script>
